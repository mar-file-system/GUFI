export

TESTTAR  = testdir.tar
TESTDIR  = testdir
TESTDST  = $(TESTDIR).gufi

ifneq ("$(CXX)", "false")
SUBDIRECTORIES=googletest
endif

TESTS    = bfwi bfti bfq bfwreaddirplus2db querydb querydbn dfw listschemadb listtablesdb groupfilespacehogusesummary userfilespacehogusesummary groupfilespacehog userfilespacehog oldbigfiles verifyknowntree $(SUBDIRECTORIES)

# these are trashable files and dirs produced by the test/run* tests
TEST_PRODUCTS = testout.* outdb* outq.* core.* bfwreaddirplusdb* $(TESTDIR) $(TESTDST) testbwrpdb

.PHONY: $(SUBDIRECTORIES) $(TESTS)

all: $(TESTS) $(SUBDIRECTORIES)

$(SUBDIRECTORIES):
	$(MAKE) -C $@ run

# extract the tarball
$(TESTDIR): $(TESTTAR)
	mkdir -p $(TESTDIR)
	tar -xf $(TESTTAR)

# generate the GUFI index
bfwi $(TESTDST) $(TESTDST): runbfti $(TESTDIR)
	./runbfwi $(TESTDIR) $(TESTDST)

bfti:                        runbfti bfwi
bfq:                         runbfq bfti
bfwreaddirplus2db:           runbfwreaddirplus2db bfti
querydb:                     runquerydb bfti
dfw:                         rundfw
listschemadb:                runlistschemadb
listtablesdb:                runlisttablesdb

bfti bfq bfwreaddirplus2db querydb dfw:
	./$< $(TESTDST)

querydbn:                    runquerydbn bfti
groupfilespacehogusesummary: rungroupfilespacehogusesummary
userfilespacehogusesummary:  runuserfilespacehogusesummary
groupfilespacehog:           rungroupfilespacehog
userfilespacehog:            runuserfilespacehog
oldbigfiles:                 runoldbigfiles

querydbn groupfilespacehogusesummary userfilespacehogusesummary groupfilespacehog userfilespacehog oldbigfiles:
	./$< $(TESTDST) 2

verifyknowntree:
	./$@

clean-%:
	$(MAKE) -C $* clean

clean: $(addprefix clean-, $(SUBDIRECTORIES))
	rm -rf $(TEST_PRODUCTS)
